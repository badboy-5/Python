一、配置设备名称
sysname {{ device.sysname }}
#
二、配置安全策略
# 2.1、远程管理ACL
#
acl number 2010
 description Management
 {%- if cfg.mode == '内网' %}
 rule 10 permit vpn-instance IPMI source 10.137.252.159 0
 rule 20 permit vpn-instance IPMI source 10.136.3.0 0.0.0.31
 rule 30 permit vpn-instance IPMI source 22.48.7.0 0.0.0.15
 rule 40 permit vpn-instance IPMI source 22.48.9.0 0.0.0.15
 {%- elif cfg.mode == '外网' %}
 rule 10 permit vpn-instance IPMI source 172.19.252.50 0
 rule 20 permit vpn-instance IPMI source 172.19.5.0 0.0.0.15
 rule 30 permit vpn-instance IPMI source 172.19.27.0 0.0.0.15
 rule 40 permit vpn-instance IPMI source 172.19.29.0 0.0.0.15
 {%- endif %}
 rule 900 deny vpn-instance IPMI
 quit
#
# 2.2、SNMP读策略ACL
#
acl number 2020
 description SNMP-READ
 {%- if cfg.mode == '内网' %}
 rule 10 permit vpn-instance IPMI source 10.137.252.159 0
 {%- elif cfg.mode == '外网' %}
 rule 10 permit vpn-instance IPMI source 172.19.252.50 0
 {%- endif %}
 rule 900 deny vpn-instance IPMI
 quit
#
{%- if cfg.port_secure == 'enable' %}
#2.3、配置端口安全
acl number 3100
 description Port-Security
 rule 0 deny udp destination-port eq netbios-dgm
 rule 5 deny udp destination-port eq netbios-ns
 rule 7 deny udp destination-port eq 593
 rule 8 deny tcp destination-port eq 593
 rule 9 deny udp destination-port eq 445
 rule 10 deny tcp destination-port eq 445
 rule 12 deny tcp destination-port eq 139
 rule 13 deny udp destination-port eq 135
 rule 14 deny tcp destination-port eq 135
 rule 55 deny tcp destination-port eq 136
 rule 60 deny tcp destination-port eq 137
 rule 70 deny tcp destination-port eq 138
 rule 1000 permit ip
 quit
#
{%- endif %}
{% if cfg.dhcp_snooping == 'enable' %}
#2.4、配置DHCP SNOOPING
#
dhcp enable
dhcp snooping enable
#
{%- endif %}
三、配置STP
#
stp mode mstp
stp bpdu-protection
stp tc-protection
#
stp region-configuration
 region-name zj.sgcc.com.cn
 revision-level 1
 active region-configuration
#
stp instance 0 priority 40960
#
四、配置管理
#
#4.1、配置VRF
#
ip vpn-instance IPMI
 ipv4-family
 quit
#
{%- if cfg.MGMT_PORT == 'vlan' %}
#4.2、创建管理VLAN
#
vlan batch {{ cfg.MGMT_PORT_ID }}
{%- endif %}
#
#4.3、配置管理IP
interface {{ cfg.MGMT_PORT }} {{ cfg.MGMT_PORT_ID }}
 ip binding vpn-instance IPMI
 ip address {{ cfg.MGMT_IP }} {{ cfg.MGMT_MASK }}
 quit
#
#4.4、配置管理路由
#
ip route-static vpn-instance IPMI 0.0.0.0 0.0.0.0 {{ cfg.MGMT_GATEWAY }} description MGMT
#
#4.5、配置SSH
stelnet ipv4 server enable
#
stelnet server enable
#
rsa local-key-pair create
#
aaa
 undo local-user policy security-enhance
 local-user admin password irreversible-cipher 密码
 local-user admin level 3
 local-user admin service-type ssh
 quit
#
user-interface vty 0 4
 authentication-mode aaa
 protocol inbound ssh
 idle-timeout 5 0
 quit
#
ssh user admin service-type stelnet
ssh user admin authentication-type password
ssh client first-time enable
#
#4.6、配置Tacacs
#
hwtacacs enable
#
hwtacacs server template 4atac
#
 {%- if cfg.mode == '内网' %}
 hwtacacs server authentication 25.194.136.64 vpn-instance IPMI
 hwtacacs server authentication 25.194.136.155 vpn-instance IPMI secondary
 hwtacacs server authorization 25.194.136.64 vpn-instance IPMI
 hwtacacs server authorization 25.194.136.155 vpn-instance IPMI secondary
 hwtacacs server accounting 25.194.136.64 vpn-instance IPMI
 hwtacacs server accounting 25.194.136.155 vpn-instance IPMI secondary
 hwtacacs server shared-key cipher admin
 hwtacacs server user-name domain-excluded
 hwtacacs server source-ip {{ cfg.MGMT_IP }}
 quit
 {%- elif cfg.mode == '外网' %}
 hwtacacs server authentication 172.19.225.180 vpn-instance IPMI
 hwtacacs server authentication 172.19.225.181 vpn-instance IPMI secondary
 hwtacacs server authorization 172.19.225.180 vpn-instance IPMI
 hwtacacs server authorization 172.19.225.181 vpn-instance IPMI secondary
 hwtacacs server accounting 172.19.225.180 vpn-instance IPMI
 hwtacacs server accounting 172.19.225.181 vpn-instance IPMI secondary
 hwtacacs server shared-key cipher As@99518
 hwtacacs server user-name domain-excluded
 hwtacacs server source-ip {{ cfg.MGMT_IP }}
 quit
 {%- endif %}
#
aaa
 authentication-scheme 4atac
  authentication-mode hwtacacs local
  quit
 authorization-scheme 4atac
  authorization-mode hwtacacs local
  quit
 domain default_admin
  authentication-scheme 4atac
  authorization-scheme 4atac
  hwtacacs server 4atac
  quit
#
ssh authentication-type default password
#
#4.7、配置Console密码
#
user-interface con 0
 authentication-mode password
 set authentication password cipher 密码
 quit
#
五、配置特性
#
#5.1、配置登录提示
header shell information "This property belongs to State Grid ZheJiang Elevtric Power Co. Ltd for authorized users only. Unauthorized access will be prosecuted"
header login information "
ROOM:{{ cfg.room }}
USE :{{ cfg.use }}
NAME:{{ cfg.sysname }}
RACK:{{ cfg.rack }}
"
#
#5.2、配置LLDP
lldp enable
#
#5.3、配置NTP
#
undo ntp server disable
ntp source-interface {{ cfg.MGMT_PORT }} {{ cfg.MGMT_PORT_ID }} vpn-instance IPMI
{%- if cfg.mode == '内网' %}
ntp unicast-server 10.137.252.67 vpn-instance IPMI source-interface {{ cfg.MGMT_PORT }} {{ cfg.MGMT_PORT_ID }}
{%- elif cfg.mode == '外网' %}
ntp unicast-server 202.107.201.1 vpn-instance IPMI source-interface {{ cfg.MGMT_PORT }} {{ cfg.MGMT_PORT_ID }}
ntp unicast-server 202.107.201.2 vpn-instance IPMI source-interface {{ cfg.MGMT_PORT }} {{ cfg.MGMT_PORT_ID }}
{%- endif %}
#
clock timezone BeiJing add 08:00:00
clock protocol ntp
#
#5.4、配置SNMP
snmp-agent
#
snmp-agent sys-info version v3
#
snmp-agent mib-view included WangGuan-RD internet
snmp-agent mib-view included WangGuan-NT internet
#
snmp-agent group v3 WangGuan privacy read-view WangGuan-RD notify-view WangGuan-NT
#
snmp-agent usm-user v3 XT5@HzTeam&win
snmp-agent usm-user v3 XT5@HzTeam&win group WangGuan
snmp-agent usm-user v3 XT5@HzTeam&win authentication-mode md5
SYy5!HzTeam!win
SYy5!HzTeam!win
snmp-agent usm-user v3 XT5@HzTeam&win privacy-mode des56
sYY5!HzTeam!win
sYY5!HzTeam!win
snmp-agent usm-user v3 XT5@HzTeam&win acl 2020
#
snmp-agent trap source {{ cfg.MGMT_PORT }} {{ cfg.MGMT_PORT_ID }}
#
{% if cfg.mode == '内网' %}
snmp-agent target-host trap address udp-domain 10.137.252.159 params securityname XT5@HzTeam&win v3 privacy
{% elif cfg.mode == '外网' %}
snmp-agent target-host trap address udp-domain 172.19.252.50 params securityname XT5@HzTeam&win v3 privacy
{% endif %}
#
snmp-agent trap enable feature-name system
snmp-agent trap enable feature-name ifnet
snmp-agent trap enable feature-name trunk
#
#5.5、配置syslog
#
info-center source ntp channel 2 log state off trap state off
info-center source default channel 2 log level warning trap level warning
info-center loghost source {{ cfg.MGMT_PORT }} {{ cfg.MGMT_PORT_ID }}
{%- if cfg.mode == '内网' %}
info-center loghost 10.137.252.159 vpn-instance IPMI source-ip {{ cfg.MGMT_IP }} level informational
{%- elif cfg.mode == '外网' %}
info-center loghost 172.19.252.50 vpn-instance IPMI source-ip {{ cfg.MGMT_IP }} level informational
{%- endif %}

{% endfor %}